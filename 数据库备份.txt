const mysql = require('mysql2/promise');

async function initializeDatabase() {
    let connection;
    try {
        // ç¬¬ä¸€æ¬¡è¿æ¥ç”¨äºåˆ›å»ºæ•°æ®åº“
        const adminConnection = await mysql.createConnection({
            host: 'localhost',
            user: 'root',
            password: 'woaizhb99' // è¯·æ›¿æ¢ä¸ºä½ çš„å¯†ç 
        });

        await adminConnection.execute(`CREATE DATABASE IF NOT EXISTS yuejie_library`);
        console.log('âœ… æ•°æ®åº“åˆ›å»ºæˆåŠŸ');
        await adminConnection.end();

        // ç¬¬äºŒæ¬¡è¿æ¥ç›´æ¥è¿æ¥åˆ°ç›®æ ‡æ•°æ®åº“
        connection = await mysql.createConnection({
            host: 'localhost',
            user: 'root',
            password: 'woaizhb99',
            database: 'yuejie_library'
        });

        // åˆ›å»ºbooksè¡¨
        await connection.execute(`CREATE TABLE IF NOT EXISTS books (
            id INT AUTO_INCREMENT PRIMARY KEY,
            title VARCHAR(255) NOT NULL,
            author VARCHAR(255) NOT NULL,
            isbn VARCHAR(20),
            cover_image VARCHAR(500),
            categories JSON,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )`);
        console.log('âœ… å›¾ä¹¦è¡¨åˆ›å»ºæˆåŠŸ');

        // åˆ›å»ºusersè¡¨
        await connection.execute(`CREATE TABLE IF NOT EXISTS users (
            id INT AUTO_INCREMENT PRIMARY KEY,
            username VARCHAR(50) NOT NULL UNIQUE,
            email VARCHAR(100) NOT NULL UNIQUE,
            password VARCHAR(255) NOT NULL,
            role ENUM('user', 'admin') DEFAULT 'user',
            books_read INT DEFAULT 0,
            reading_time INT DEFAULT 0,
            reading_preferences TEXT,
            last_active TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )`);
        console.log('âœ… ç”¨æˆ·è¡¨åˆ›å»ºæˆåŠŸ');

        // åˆ›å»ºfeedbackè¡¨
        await connection.execute(`CREATE TABLE IF NOT EXISTS feedback (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            email VARCHAR(100) NOT NULL,
            issue_type VARCHAR(50) NOT NULL,
            subject VARCHAR(255) NOT NULL,
            description TEXT NOT NULL,
            status ENUM('new', 'in_progress', 'resolved') DEFAULT 'new',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )`);
        console.log('âœ… åé¦ˆè¡¨åˆ›å»ºæˆåŠŸ');

        // åˆ›å»ºé˜…è¯»å†å²è¡¨
        await connection.execute(`CREATE TABLE IF NOT EXISTS reading_history (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            book_id INT NOT NULL,
            start_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            end_date TIMESTAMP NULL,
            reading_time INT DEFAULT 0 COMMENT 'é˜…è¯»æ—¶é•¿(åˆ†é’Ÿ)',
            status ENUM('reading', 'completed', 'paused') DEFAULT 'reading',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE,
            INDEX idx_user_id (user_id),
            INDEX idx_book_id (book_id)
        )`);
        console.log('âœ… é˜…è¯»å†å²è¡¨åˆ›å»ºæˆåŠŸ');

        // åˆ›å»ºç”¨æˆ·ä¹¦æ¶è¡¨
        await connection.execute(`CREATE TABLE IF NOT EXISTS user_bookshelf (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            book_id INT NOT NULL,
            added_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            shelf_type ENUM('want_to_read', 'reading', 'read') DEFAULT 'want_to_read',
            rating TINYINT DEFAULT 0 COMMENT 'è¯„åˆ† 1-5',
            notes TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE,
            UNIQUE KEY unique_user_book (user_id, book_id),
            INDEX idx_user_id (user_id)
        )`);
        console.log('âœ… ç”¨æˆ·ä¹¦æ¶è¡¨åˆ›å»ºæˆåŠŸ');

        // åˆ›å»ºå½“å‰é˜…è¯»è¡¨
        await connection.execute(`CREATE TABLE IF NOT EXISTS current_reading (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            book_id INT NOT NULL,
            current_page INT DEFAULT 0,
            total_pages INT DEFAULT 0,
            start_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_read TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            reading_session_time INT DEFAULT 0 COMMENT 'æœ¬æ¬¡é˜…è¯»æ—¶é•¿(åˆ†é’Ÿ)',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE,
            UNIQUE KEY unique_user_current (user_id),
            INDEX idx_user_id (user_id)
        )`);
        console.log('âœ… å½“å‰é˜…è¯»è¡¨åˆ›å»ºæˆåŠŸ');

        // æ’å…¥å›¾ä¹¦æ•°æ®
        const booksData = [
            {
                title: "ç™¾å¹´å­¤ç‹¬",
                author: "åŠ è¥¿äºšÂ·é©¬å°”å…‹æ–¯",
                isbn: "9787544253994",
                cover_image: "/photo/ç™¾å¹´å­¤ç‹¬.jpg",
                categories: JSON.stringify(["æ–‡å­¦å°è¯´", "ä¸­æ–‡å›¾ä¹¦", "è·å¥–ä½œå“"])
            },
            {
                title: "æ—¶é—´ç®€å²",
                author: "å²è’‚èŠ¬Â·éœé‡‘",
                isbn: "9787535732309",
                cover_image: "/photo/æ—¶é—´ç®€å².jpg",
                categories: JSON.stringify(["è‡ªç„¶ç§‘å­¦", "è‹±æ–‡åŸç‰ˆ", "ç°ä»£å‡ºç‰ˆç‰©"])
            },
            {
                title: "è®¾è®¡å¿ƒç†å­¦",
                author: "å”çº³å¾·Â·è¯ºæ›¼",
                isbn: "9787121284554",
                cover_image: "/photo/è®¾è®¡å¿ƒç†å­¦.jpg",
                categories: JSON.stringify(["è‰ºæœ¯è®¾è®¡", "ç¤¾ä¼šç§‘å­¦", "è‹±æ–‡åŸç‰ˆ"])
            },
            {
                title: "äººç±»ç®€å²",
                author: "å°¤ç“¦å°”Â·èµ«æ‹‰åˆ©",
                isbn: "9787508647357",
                cover_image: "/photo/äººç±»ç®€å².jpg",
                categories: JSON.stringify(["å†å²åœ°ç†", "ç¤¾ä¼šç§‘å­¦", "æœ€æ–°ä¸Šæ¶"])
            },
            {
                title: "å›½å¯Œè®º",
                author: "äºšå½“Â·æ–¯å¯†",
                isbn: "9787100152653",
                cover_image: "/photo/å›½å¯Œè®º.jpg",
                categories: JSON.stringify(["ç»æµç®¡ç†", "å“²å­¦å®—æ•™", "å¤ç±æ–‡çŒ®"])
            },
            {
                title: "å°ç‹å­",
                author: "å®‰æ‰˜ä¸‡Â·å¾·Â·åœ£-åŸƒå…‹è‹ä½©é‡Œ",
                isbn: "9787020042494",
                cover_image: "/photo/å°ç‹å­.jpg",
                categories: JSON.stringify(["å„¿ç«¥æ–‡å­¦", "æ³•è¯­å›¾ä¹¦", "è·å¥–ä½œå“"])
            },
            {
                title: "ä¸‰ä½“",
                author: "åˆ˜æ…ˆæ¬£",
                isbn: "9787536692930",
                cover_image: "/photo/ä¸‰ä½“.jpg",
                categories: JSON.stringify(["æ–‡å­¦å°è¯´", "ä¸­æ–‡å›¾ä¹¦", "è·å¥–ä½œå“"])
            },
            {
                title: "ç®—æ³•å¯¼è®º",
                author: "æ‰˜é©¬æ–¯Â·ç§‘æ›¼",
                isbn: "9787111407010",
                cover_image: "/photo/ç®—æ³•å¯¼è®º.jpg",
                categories: JSON.stringify(["å·¥ç¨‹æŠ€æœ¯", "è‹±æ–‡åŸç‰ˆ", "ç°ä»£å‡ºç‰ˆç‰©"])
            }
        ];

        // æ¸…ç©ºå¹¶é‡æ–°æ’å…¥å›¾ä¹¦æ•°æ®
        await connection.execute('DELETE FROM books');
        for (const book of booksData) {
            await connection.execute(
                `INSERT INTO books (title, author, isbn, cover_image, categories) 
                 VALUES (?, ?, ?, ?, ?)`, 
                [book.title, book.author, book.isbn, book.cover_image, book.categories]
            );
        }
        console.log('âœ… å›¾ä¹¦æ•°æ®æ’å…¥æˆåŠŸ');

        // åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ· (å¯†ç : admin123)
        const crypto = require('crypto');
        const hashedPassword = crypto.createHash('md5').update('admin123').digest('hex');
        
        await connection.execute(`
            INSERT INTO users (username, email, password, role, books_read, reading_time, reading_preferences) 
            VALUES ('admin', 'admin@yuejie.com', ?, 'admin', 2, 640, 'ç§‘å¹»,æ–‡å­¦,ç§‘æ™®')
            ON DUPLICATE KEY UPDATE 
            password = VALUES(password),
            role = VALUES(role),
            books_read = VALUES(books_read),
            reading_time = VALUES(reading_time),
            reading_preferences = VALUES(reading_preferences)
        `, [hashedPassword]);
        console.log('âœ… ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºæˆåŠŸ');

        // è·å–ç”¨æˆ·IDå’Œå›¾ä¹¦IDç”¨äºæ’å…¥å…³è”æ•°æ®
        const [adminUser] = await connection.execute('SELECT id FROM users WHERE username = "admin"');
        const [books] = await connection.execute('SELECT id, title FROM books');
        
        const adminId = adminUser[0].id;
        const bookMap = {};
        books.forEach(book => {
            bookMap[book.title] = book.id;
        });

        // æ¸…ç©ºå¹¶æ’å…¥é˜…è¯»å†å²æ•°æ®
        await connection.execute('DELETE FROM reading_history WHERE user_id = ?', [adminId]);
        const readingHistoryData = [
            { bookTitle: "ç™¾å¹´å­¤ç‹¬", start: '2024-01-15 10:00:00', end: '2024-01-20 15:30:00', time: 360, status: 'completed' },
            { bookTitle: "æ—¶é—´ç®€å²", start: '2024-02-01 14:00:00', end: '2024-02-10 11:20:00', time: 280, status: 'completed' },
            { bookTitle: "ä¸‰ä½“", start: '2024-03-05 09:30:00', end: null, time: 180, status: 'reading' },
            { bookTitle: "å°ç‹å­", start: '2024-03-10 16:45:00', end: null, time: 90, status: 'paused' }
        ];

        for (const history of readingHistoryData) {
            await connection.execute(
                `INSERT INTO reading_history (user_id, book_id, start_date, end_date, reading_time, status) 
                 VALUES (?, ?, ?, ?, ?, ?)`,
                [adminId, bookMap[history.bookTitle], history.start, history.end, history.time, history.status]
            );
        }
        console.log('âœ… é˜…è¯»å†å²æ•°æ®æ’å…¥æˆåŠŸ');

        // æ¸…ç©ºå¹¶æ’å…¥ç”¨æˆ·ä¹¦æ¶æ•°æ®
        await connection.execute('DELETE FROM user_bookshelf WHERE user_id = ?', [adminId]);
        const bookshelfData = [
            { bookTitle: "ç™¾å¹´å­¤ç‹¬", shelfType: 'read', rating: 5, notes: 'éå¸¸éœ‡æ’¼çš„é­”å¹»ç°å®ä¸»ä¹‰ä½œå“' },
            { bookTitle: "æ—¶é—´ç®€å²", shelfType: 'read', rating: 4, notes: 'ç§‘æ™®ç»å…¸ï¼Œç†è§£å®‡å®™çš„å…¥é—¨è¯»ç‰©' },
            { bookTitle: "ä¸‰ä½“", shelfType: 'reading', rating: 0, notes: 'æ­£åœ¨é˜…è¯»ï¼Œç§‘å¹»æ„æ€å¾ˆç‹¬ç‰¹' },
            { bookTitle: "å°ç‹å­", shelfType: 'want_to_read', rating: 0, notes: 'å‡†å¤‡é˜…è¯»çš„ç»å…¸ç«¥è¯' },
            { bookTitle: "äººç±»ç®€å²", shelfType: 'want_to_read', rating: 0, notes: 'å¯¹äººç±»å†å²çš„å®è§‚è§†è§’' },
            { bookTitle: "è®¾è®¡å¿ƒç†å­¦", shelfType: 'want_to_read', rating: 0, notes: 'å­¦ä¹ è®¾è®¡æ€ç»´' }
        ];

        for (const shelf of bookshelfData) {
            await connection.execute(
                `INSERT INTO user_bookshelf (user_id, book_id, shelf_type, rating, notes) 
                 VALUES (?, ?, ?, ?, ?)`,
                [adminId, bookMap[shelf.bookTitle], shelf.shelfType, shelf.rating, shelf.notes]
            );
        }
        console.log('âœ… ç”¨æˆ·ä¹¦æ¶æ•°æ®æ’å…¥æˆåŠŸ');

        // æ¸…ç©ºå¹¶æ’å…¥å½“å‰é˜…è¯»æ•°æ®
        await connection.execute('DELETE FROM current_reading WHERE user_id = ?', [adminId]);
        await connection.execute(
            `INSERT INTO current_reading (user_id, book_id, current_page, total_pages, start_date) 
             VALUES (?, ?, ?, ?, ?)`,
            [adminId, bookMap["ä¸‰ä½“"], 195, 300, '2024-03-05 09:30:00']
        );
        console.log('âœ… å½“å‰é˜…è¯»æ•°æ®æ’å…¥æˆåŠŸ');

        console.log('ğŸ‰ æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼');
        console.log('ğŸ“ ç®¡ç†å‘˜è´¦å·: admin / admin123');

    } catch (error) {
        console.error('âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error);
    } finally {
        if (connection) {
            await connection.end();
        }
    }
}

// æ‰§è¡Œåˆå§‹åŒ–å‡½æ•°
initializeDatabase();